<div class="scan-page">
  <div class="brand-selector page-content">
    <div class="brand-row">
      <pw-brand-autocomplete
        #brandInput
        label="Shopping at..."
        [initialValue]="selectedBrand()"
        (brandSelected)="onBrandPreSelected($event)"
      />
      @if (selectedBrand()) {
        <button
          mat-icon-button
          class="clear-brand-btn"
          (click)="clearBrand()"
          aria-label="Clear brand"
        >
          <mat-icon>close</mat-icon>
        </button>
      }
    </div>
  </div>

  <div class="scanner-viewport" [class.hidden]="scannedProduct() !== null || nonEan13Prompt() !== null">
    <div #scannerTarget class="scanner-target"></div>
    @if (scannerError(); as error) {
      <div class="scanner-error">
        <mat-icon>videocam_off</mat-icon>
        <p>{{ error }}</p>
        <button mat-flat-button (click)="startScanning()">Retry</button>
      </div>
    }
  </div>

  @if (nonEan13Prompt(); as barcode) {
    <div class="ean13-prompt page-content">
      <mat-icon class="prompt-icon">warning</mat-icon>
      <h3>Non-standard barcode detected</h3>
      <p class="barcode-label">{{ barcode }}</p>
      <p>This barcode is {{ barcode.length }} digits long instead of the standard 13 (EAN-13). Do you want to use it anyway?</p>
      <div class="prompt-actions">
        <button mat-flat-button color="primary" (click)="acceptNonEan13()">
          Use this barcode
        </button>
        <button mat-stroked-button (click)="rejectNonEan13()">
          Keep scanning
        </button>
      </div>
    </div>
  }

  @if (scannedProduct(); as product) {
    <div class="scan-result page-content">
      <h2>{{ product.name }}</h2>
      <p class="barcode-label">{{ product.barcode }}</p>

      @if (getCheapestFullPrice(product); as cheapest) {
        <div class="cheapest-badge">
          <span class="cheapest-label">Cheapest:</span>
          <span class="cheapest-price">
            {{ formatCentsToEuro(cheapest.price.price) }}
          </span>
          <span class="cheapest-brand">@ {{ cheapest.brand }}</span>
        </div>
      }

      <div class="prices-list">
        @for (
          sm of sortSupermarketsCheapestFirst(product.supermarkets);
          track sm.brand
        ) {
          <div
            class="price-entry"
            [class.highlighted]="
              selectedBrand() &&
              sm.brand.toLowerCase() === selectedBrand().toLowerCase()
            "
          >
            <span class="brand-name">{{ sm.brand }}</span>
            <div class="prices">
              @if (getCurrentFullPrice(sm); as fullPrice) {
                <span class="full-price">
                  {{ formatCentsToEuro(fullPrice.price) }}
                </span>
              }
              @if (sm.discountedPrice) {
                <span class="discounted-price">
                  {{ formatCentsToEuro(sm.discountedPrice.price) }}
                  <small>(sale)</small>
                </span>
              }
            </div>
          </div>
        }
      </div>

      <div class="actions">
        <button
          mat-flat-button
          color="primary"
          (click)="goToProductDetail(product.barcode)"
        >
          View Details
        </button>
        <button
          mat-stroked-button
          (click)="goToUpdatePrice(product.barcode)"
        >
          Update Price
        </button>
        <button mat-stroked-button (click)="resumeScanning()">
          <mat-icon>qr_code_scanner</mat-icon>
          Scan Again
        </button>
      </div>
    </div>
  }
</div>
