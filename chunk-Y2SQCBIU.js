import{V as g,pa as m}from"./chunk-U2MXLZLO.js";var a={PRODUCTS:"pw_products",BRANDS:"pw_brands",SELECTED_BRAND:"pw_selected_brand"},b=1;function f(o){let e=o.fullPriceHistory;return e.length>0?e[e.length-1]:null}function _(o){let e=null;for(let r of o.supermarkets){let t=f(r);t&&(!e||t.price<e.price.price)&&(e={brand:r.brand,price:t})}return e}function D(o){let e=null;for(let r of o.supermarkets)r.discountedPrice&&(!e||r.discountedPrice.price<e.price.price)&&(e={brand:r.brand,price:r.discountedPrice});return e}function v(o){return`\u20AC${(o/100).toFixed(2)}`}function R(o){return[...o].sort((e,r)=>{let t=f(e)?.price??1/0,i=f(r)?.price??1/0;return t-i})}var h=class o{_products=m(this.loadProducts());_brands=m(this.loadBrands());_selectedBrand=m(this.loadSelectedBrand());products=this._products.asReadonly();brands=this._brands.asReadonly();selectedBrand=this._selectedBrand.asReadonly();loadProducts(){try{let e=localStorage.getItem(a.PRODUCTS);return e?JSON.parse(e):[]}catch{return[]}}persistProducts(e){localStorage.setItem(a.PRODUCTS,JSON.stringify(e)),this._products.set(e)}loadBrands(){try{let e=localStorage.getItem(a.BRANDS);return e?JSON.parse(e):[]}catch{return[]}}persistBrands(e){localStorage.setItem(a.BRANDS,JSON.stringify(e)),this._brands.set(e)}loadSelectedBrand(){return localStorage.getItem(a.SELECTED_BRAND)??""}setSelectedBrand(e){localStorage.setItem(a.SELECTED_BRAND,e),this._selectedBrand.set(e)}clearSelectedBrand(){localStorage.removeItem(a.SELECTED_BRAND),this._selectedBrand.set("")}getProduct(e){return this._products().find(r=>r.barcode===e)??null}saveProduct(e){let r=[...this._products()],t=r.findIndex(i=>i.barcode===e.barcode);t>=0?r[t]=e:r.push(e),this.persistProducts(r)}deleteProduct(e){this.persistProducts(this._products().filter(r=>r.barcode!==e))}updateProductName(e,r){let t=this.getProduct(e);t&&(t.name=r.trim()||e,this.saveProduct(t))}addBrand(e){let r=e.trim();if(!r)return;let t=this._brands();t.some(i=>i.toLowerCase()===r.toLowerCase())||this.persistBrands([...t,r].sort())}addOrUpdatePrice(e,r,t,i,c){let s=this.getProduct(e),l=Date.now(),d={price:t,timestamp:l};s||(s={barcode:e,name:c??e,supermarkets:[]}),c&&(s.name=c);let n=s.supermarkets.find(u=>u.brand.toLowerCase()===r.toLowerCase());n||(n={brand:r,fullPriceHistory:[],discountedPrice:null},s.supermarkets.push(n)),i?n.discountedPrice=d:n.fullPriceHistory.push(d),this.saveProduct(s),this.addBrand(r)}removeDiscountedPrice(e,r){let t=this.getProduct(e);if(!t)return;let i=t.supermarkets.find(c=>c.brand.toLowerCase()===r.toLowerCase());i&&(i.discountedPrice=null,this.saveProduct(t))}exportDatabase(){return{products:this._products(),brands:this._brands(),exportedAt:Date.now(),version:b}}importDatabase(e){let r={productsAdded:0,productsUpdated:0,brandsAdded:0},t=[...this._products()];for(let s of e.products){let l=t.findIndex(d=>d.barcode===s.barcode);if(l<0)t.push(s),r.productsAdded++;else{let d=t[l];for(let n of s.supermarkets){let u=d.supermarkets.find(P=>P.brand.toLowerCase()===n.brand.toLowerCase());if(!u)d.supermarkets.push(n);else{let P=new Set(u.fullPriceHistory.map(p=>p.timestamp));for(let p of n.fullPriceHistory)P.has(p.timestamp)||u.fullPriceHistory.push(p);u.fullPriceHistory.sort((p,S)=>p.timestamp-S.timestamp),n.discountedPrice&&(!u.discountedPrice||n.discountedPrice.timestamp>u.discountedPrice.timestamp)&&(u.discountedPrice=n.discountedPrice)}}s.name&&d.name===d.barcode&&(d.name=s.name),t[l]=d,r.productsUpdated++}}this.persistProducts(t);let i=new Set(this._brands().map(s=>s.toLowerCase())),c=[];for(let s of e.brands)i.has(s.toLowerCase())||(c.push(s),r.brandsAdded++);return c.length>0&&this.persistBrands([...this._brands(),...c].sort()),r}clearAll(){localStorage.removeItem(a.PRODUCTS),localStorage.removeItem(a.BRANDS),localStorage.removeItem(a.SELECTED_BRAND),this._products.set([]),this._brands.set([]),this._selectedBrand.set("")}static \u0275fac=function(r){return new(r||o)};static \u0275prov=g({token:o,factory:o.\u0275fac,providedIn:"root"})};export{f as a,_ as b,D as c,v as d,R as e,h as f};
