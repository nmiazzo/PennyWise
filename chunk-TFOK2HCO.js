import{V as b,pa as P}from"./chunk-U2MXLZLO.js";var u={PRODUCTS:"pw_products",BRANDS:"pw_brands"},g=1;function f(i){let r=i.fullPriceHistory;return r.length>0?r[r.length-1]:null}function y(i){let r=null;for(let e of i.supermarkets){let t=f(e);t&&(!r||t.price<r.price.price)&&(r={brand:e.brand,price:t})}return r}function R(i){let r=null;for(let e of i.supermarkets)e.discountedPrice&&(!r||e.discountedPrice.price<r.price.price)&&(r={brand:e.brand,price:e.discountedPrice});return r}function v(i){return`\u20AC${(i/100).toFixed(2)}`}function x(i){return[...i].sort((r,e)=>{let t=f(r)?.price??1/0,o=f(e)?.price??1/0;return t-o})}var h=class i{_products=P(this.loadProducts());_brands=P(this.loadBrands());products=this._products.asReadonly();brands=this._brands.asReadonly();loadProducts(){try{let r=localStorage.getItem(u.PRODUCTS);return r?JSON.parse(r):[]}catch{return[]}}persistProducts(r){localStorage.setItem(u.PRODUCTS,JSON.stringify(r)),this._products.set(r)}loadBrands(){try{let r=localStorage.getItem(u.BRANDS);return r?JSON.parse(r):[]}catch{return[]}}persistBrands(r){localStorage.setItem(u.BRANDS,JSON.stringify(r)),this._brands.set(r)}getProduct(r){return this._products().find(e=>e.barcode===r)??null}saveProduct(r){let e=[...this._products()],t=e.findIndex(o=>o.barcode===r.barcode);t>=0?e[t]=r:e.push(r),this.persistProducts(e)}deleteProduct(r){this.persistProducts(this._products().filter(e=>e.barcode!==r))}addBrand(r){let e=r.trim();if(!e)return;let t=this._brands();t.some(o=>o.toLowerCase()===e.toLowerCase())||this.persistBrands([...t,e].sort())}addOrUpdatePrice(r,e,t,o,d){let s=this.getProduct(r),l=Date.now(),c={price:t,timestamp:l};s||(s={barcode:r,name:d??r,supermarkets:[]}),d&&(s.name=d);let n=s.supermarkets.find(a=>a.brand.toLowerCase()===e.toLowerCase());n||(n={brand:e,fullPriceHistory:[],discountedPrice:null},s.supermarkets.push(n)),o?n.discountedPrice=c:n.fullPriceHistory.push(c),this.saveProduct(s),this.addBrand(e)}removeDiscountedPrice(r,e){let t=this.getProduct(r);if(!t)return;let o=t.supermarkets.find(d=>d.brand.toLowerCase()===e.toLowerCase());o&&(o.discountedPrice=null,this.saveProduct(t))}exportDatabase(){return{products:this._products(),brands:this._brands(),exportedAt:Date.now(),version:g}}importDatabase(r){let e={productsAdded:0,productsUpdated:0,brandsAdded:0},t=[...this._products()];for(let s of r.products){let l=t.findIndex(c=>c.barcode===s.barcode);if(l<0)t.push(s),e.productsAdded++;else{let c=t[l];for(let n of s.supermarkets){let a=c.supermarkets.find(m=>m.brand.toLowerCase()===n.brand.toLowerCase());if(!a)c.supermarkets.push(n);else{let m=new Set(a.fullPriceHistory.map(p=>p.timestamp));for(let p of n.fullPriceHistory)m.has(p.timestamp)||a.fullPriceHistory.push(p);a.fullPriceHistory.sort((p,S)=>p.timestamp-S.timestamp),n.discountedPrice&&(!a.discountedPrice||n.discountedPrice.timestamp>a.discountedPrice.timestamp)&&(a.discountedPrice=n.discountedPrice)}}s.name&&c.name===c.barcode&&(c.name=s.name),t[l]=c,e.productsUpdated++}}this.persistProducts(t);let o=new Set(this._brands().map(s=>s.toLowerCase())),d=[];for(let s of r.brands)o.has(s.toLowerCase())||(d.push(s),e.brandsAdded++);return d.length>0&&this.persistBrands([...this._brands(),...d].sort()),e}clearAll(){localStorage.removeItem(u.PRODUCTS),localStorage.removeItem(u.BRANDS),this._products.set([]),this._brands.set([])}static \u0275fac=function(e){return new(e||i)};static \u0275prov=b({token:i,factory:i.\u0275fac,providedIn:"root"})};export{f as a,y as b,R as c,v as d,x as e,h as f};
